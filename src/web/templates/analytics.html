{% extends "base.html" %}

{% block title %}Analytics - CryptoAI Trading Bot{% endblock %}

{% block content %}
<div class="row">
    <!-- Time Period Selector -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-bar me-2"></i>Analytics Dashboard
                        </h5>
                    </div>
                    <div class="col-md-4">
                        <select id="periodSelector" class="form-select" onchange="updatePeriod()">
                            <option value="1h">Última Hora</option>
                            <option value="6h">Últimas 6 Horas</option>
                            <option value="24h" selected>Últimas 24 Horas</option>
                            <option value="7d">Últimos 7 Dias</option>
                            <option value="30d">Últimos 30 Dias</option>
                            <option value="all">Todo Período</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Metrics Row -->
    <div class="col-12 mb-4">
        <div class="row">
            <div class="col-md-2">
                <div class="metric-card text-center">
                    <div class="metric-label">ROI</div>
                    <div id="totalROI" class="metric-value">0%</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="metric-card text-center">
                    <div class="metric-label">Sharpe Ratio</div>
                    <div id="sharpeRatio" class="metric-value">0.00</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="metric-card text-center">
                    <div class="metric-label">Max Drawdown</div>
                    <div id="maxDrawdown" class="metric-value text-danger">0%</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="metric-card text-center">
                    <div class="metric-label">Profit Factor</div>
                    <div id="profitFactor" class="metric-value">0.00</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="metric-card text-center">
                    <div class="metric-label">Avg Trade Duration</div>
                    <div id="avgTradeDuration" class="metric-value">0m</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="metric-card text-center">
                    <div class="metric-label">Volatilidade</div>
                    <div id="volatility" class="metric-value">0%</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="col-lg-8">
        <!-- Equity Curve -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>Curva de Capital
                </h5>
                <button class="btn btn-outline-light btn-sm" onclick="refreshEquityCurve()">
                    <i class="fas fa-refresh"></i>
                </button>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="equityCurveChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Daily P&L Chart -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-bar me-2"></i>P&L Diário
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="dailyPnlChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Win/Loss Distribution -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>Distribuição de Resultados
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="chart-container" style="height: 250px;">
                            <canvas id="winLossChart"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="chart-container" style="height: 250px;">
                            <canvas id="pnlDistributionChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Performance Summary -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-trophy me-2"></i>Resumo de Performance
                </h5>
            </div>
            <div class="card-body">
                <div id="performanceSummary">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                        <p>Carregando dados...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Risk Metrics -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-shield-alt me-2"></i>Métricas de Risco
                </h5>
            </div>
            <div class="card-body">
                <div id="riskMetrics">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                        <p>Carregando dados...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Assets Performance -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-coins me-2"></i>Melhores Ativos
                </h5>
            </div>
            <div class="card-body">
                <div id="topAssetsPerformance">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                        <p>Carregando dados...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trading Hours Analysis -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-clock me-2"></i>Análise por Horário
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 200px;">
                    <canvas id="tradingHoursChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Analysis Modal -->
<div class="modal fade" id="detailedAnalysisModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-microscope me-2"></i>Análise Detalhada
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detailedAnalysisContent">
                <!-- Detailed analysis content will be loaded here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentPeriod = '24h';
    let charts = {};

    // Initialize analytics page
    document.addEventListener('DOMContentLoaded', function() {
        initializeCharts();
        loadAnalyticsData();
    });

    // Initialize all charts
    function initializeCharts() {
        initializeEquityCurveChart();
        initializeDailyPnlChart();
        initializeWinLossChart();
        initializePnlDistributionChart();
        initializeTradingHoursChart();
    }

    // Initialize equity curve chart
    function initializeEquityCurveChart() {
        const ctx = document.getElementById('equityCurveChart').getContext('2d');
        charts.equityCurve = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Capital',
                    data: [],
                    borderColor: '#17a2b8',
                    backgroundColor: 'rgba(23, 162, 184, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }, {
                    label: 'Drawdown',
                    data: [],
                    borderColor: '#dc3545',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    borderWidth: 1,
                    fill: true,
                    tension: 0.4,
                    yAxisID: 'y1'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    legend: {
                        labels: { color: '#ffffff' }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                if (context.datasetIndex === 0) {
                                    return `Capital: ${formatCurrency(context.parsed.y)}`;
                                } else {
                                    return `Drawdown: ${formatPercentage(context.parsed.y)}`;
                                }
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: { color: '#ffffff' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        ticks: {
                            color: '#ffffff',
                            callback: function(value) {
                                return formatCurrency(value);
                            }
                        },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        ticks: {
                            color: '#ffffff',
                            callback: function(value) {
                                return formatPercentage(value);
                            }
                        },
                        grid: {
                            drawOnChartArea: false,
                        }
                    }
                }
            }
        });
    }

    // Initialize daily P&L chart
    function initializeDailyPnlChart() {
        const ctx = document.getElementById('dailyPnlChart').getContext('2d');
        charts.dailyPnl = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: 'P&L Diário',
                    data: [],
                    backgroundColor: function(context) {
                        return context.parsed.y >= 0 ? '#28a745' : '#dc3545';
                    },
                    borderColor: function(context) {
                        return context.parsed.y >= 0 ? '#28a745' : '#dc3545';
                    },
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: { color: '#ffffff' }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `P&L: ${formatCurrency(context.parsed.y)}`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: { color: '#ffffff' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    },
                    y: {
                        ticks: {
                            color: '#ffffff',
                            callback: function(value) {
                                return formatCurrency(value);
                            }
                        },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    }
                }
            }
        });
    }

    // Initialize win/loss chart
    function initializeWinLossChart() {
        const ctx = document.getElementById('winLossChart').getContext('2d');
        charts.winLoss = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Vitórias', 'Derrotas'],
                datasets: [{
                    data: [0, 0],
                    backgroundColor: ['#28a745', '#dc3545'],
                    borderColor: ['#28a745', '#dc3545'],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { color: '#ffffff' }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((context.parsed / total) * 100).toFixed(1);
                                return `${context.label}: ${context.parsed} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    // Initialize P&L distribution chart
    function initializePnlDistributionChart() {
        const ctx = document.getElementById('pnlDistributionChart').getContext('2d');
        charts.pnlDistribution = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: 'Frequência',
                    data: [],
                    backgroundColor: 'rgba(23, 162, 184, 0.7)',
                    borderColor: '#17a2b8',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: { color: '#ffffff' }
                    },
                    title: {
                        display: true,
                        text: 'Distribuição de P&L',
                        color: '#ffffff'
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'P&L Range ($)',
                            color: '#ffffff'
                        },
                        ticks: { color: '#ffffff' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Frequência',
                            color: '#ffffff'
                        },
                        ticks: { color: '#ffffff' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    }
                }
            }
        });
    }

    // Initialize trading hours chart
    function initializeTradingHoursChart() {
        const ctx = document.getElementById('tradingHoursChart').getContext('2d');
        charts.tradingHours = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Array.from({length: 24}, (_, i) => `${i.toString().padStart(2, '0')}:00`),
                datasets: [{
                    label: 'P&L Médio',
                    data: new Array(24).fill(0),
                    borderColor: '#ffc107',
                    backgroundColor: 'rgba(255, 193, 7, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: { color: '#ffffff' }
                    }
                },
                scales: {
                    x: {
                        ticks: { color: '#ffffff' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    },
                    y: {
                        ticks: {
                            color: '#ffffff',
                            callback: function(value) {
                                return formatCurrency(value);
                            }
                        },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    }
                }
            }
        });
    }

    // Load analytics data
    function loadAnalyticsData() {
        loadKeyMetrics();
        loadEquityCurveData();
        loadDailyPnlData();
        loadWinLossData();
        loadPerformanceSummary();
        loadRiskMetrics();
        loadTopAssetsPerformance();
        loadTradingHoursData();
    }

    // Update period
    function updatePeriod() {
        currentPeriod = document.getElementById('periodSelector').value;
        loadAnalyticsData();
    }

    // Load key metrics
    function loadKeyMetrics() {
        fetch(`/api/analytics/metrics?period=${currentPeriod}`)
            .then(response => response.json())
            .then(data => {
                updateKeyMetrics(data);
            })
            .catch(error => {
                console.error('Erro ao carregar métricas chave:', error);
            });
    }

    // Update key metrics
    function updateKeyMetrics(data) {
        const roiElement = document.getElementById('totalROI');
        const roi = data.roi || 0;
        roiElement.textContent = formatPercentage(roi);
        roiElement.className = 'metric-value ' + (roi >= 0 ? 'positive' : 'negative');
        
        document.getElementById('sharpeRatio').textContent = (data.sharpe_ratio || 0).toFixed(2);
        document.getElementById('maxDrawdown').textContent = formatPercentage(data.max_drawdown || 0);
        document.getElementById('profitFactor').textContent = (data.profit_factor || 0).toFixed(2);
        document.getElementById('avgTradeDuration').textContent = data.avg_trade_duration || '0m';
        document.getElementById('volatility').textContent = formatPercentage(data.volatility || 0);
    }

    // Load equity curve data
    function loadEquityCurveData() {
        fetch(`/api/analytics/equity-curve?period=${currentPeriod}`)
            .then(response => response.json())
            .then(data => {
                updateEquityCurve(data);
            })
            .catch(error => {
                console.error('Erro ao carregar curva de capital:', error);
            });
    }

    // Update equity curve
    function updateEquityCurve(data) {
        const chart = charts.equityCurve;
        const equity = data.equity || [];
        const drawdown = data.drawdown || [];
        
        chart.data.labels = equity.map(point => 
            new Date(point.timestamp).toLocaleString('pt-BR', { 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            })
        );
        chart.data.datasets[0].data = equity.map(point => point.balance);
        chart.data.datasets[1].data = drawdown.map(point => point.drawdown_percent);
        chart.update();
    }

    // Load daily P&L data
    function loadDailyPnlData() {
        fetch(`/api/analytics/daily-pnl?period=${currentPeriod}`)
            .then(response => response.json())
            .then(data => {
                updateDailyPnl(data);
            })
            .catch(error => {
                console.error('Erro ao carregar P&L diário:', error);
            });
    }

    // Update daily P&L
    function updateDailyPnl(data) {
        const chart = charts.dailyPnl;
        const dailyPnl = data.daily_pnl || [];
        
        chart.data.labels = dailyPnl.map(point => 
            new Date(point.date).toLocaleDateString('pt-BR', { 
                month: 'short', 
                day: 'numeric' 
            })
        );
        chart.data.datasets[0].data = dailyPnl.map(point => point.pnl);
        chart.update();
    }

    // Load win/loss data
    function loadWinLossData() {
        fetch(`/api/analytics/win-loss?period=${currentPeriod}`)
            .then(response => response.json())
            .then(data => {
                updateWinLoss(data);
                updatePnlDistribution(data);
            })
            .catch(error => {
                console.error('Erro ao carregar dados de vitórias/derrotas:', error);
            });
    }

    // Update win/loss chart
    function updateWinLoss(data) {
        const chart = charts.winLoss;
        chart.data.datasets[0].data = [data.wins || 0, data.losses || 0];
        chart.update();
    }

    // Update P&L distribution
    function updatePnlDistribution(data) {
        const chart = charts.pnlDistribution;
        const distribution = data.pnl_distribution || [];
        
        chart.data.labels = distribution.map(point => point.range);
        chart.data.datasets[0].data = distribution.map(point => point.count);
        chart.update();
    }

    // Load performance summary
    function loadPerformanceSummary() {
        fetch(`/api/analytics/performance-summary?period=${currentPeriod}`)
            .then(response => response.json())
            .then(data => {
                displayPerformanceSummary(data);
            })
            .catch(error => {
                document.getElementById('performanceSummary').innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                        <p>Erro ao carregar dados</p>
                    </div>
                `;
                console.error('Erro ao carregar resumo de performance:', error);
            });
    }

    // Display performance summary
    function displayPerformanceSummary(data) {
        const container = document.getElementById('performanceSummary');
        
        const summaryHTML = `
            <div class="row text-center">
                <div class="col-6 mb-3">
                    <div class="border-end border-secondary">
                        <div class="h4 ${data.total_pnl >= 0 ? 'text-success' : 'text-danger'}">
                            ${formatCurrency(data.total_pnl || 0)}
                        </div>
                        <div class="small text-muted">P&L Total</div>
                    </div>
                </div>
                <div class="col-6 mb-3">
                    <div class="h4 text-info">${data.total_trades || 0}</div>
                    <div class="small text-muted">Total Trades</div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-12">
                    <div class="mb-2">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">Win Rate:</span>
                            <span class="text-success">${formatPercentage(data.win_rate || 0)}</span>
                        </div>
                    </div>
                    <div class="mb-2">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">Avg Win:</span>
                            <span class="text-success">${formatCurrency(data.avg_win || 0)}</span>
                        </div>
                    </div>
                    <div class="mb-2">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">Avg Loss:</span>
                            <span class="text-danger">${formatCurrency(data.avg_loss || 0)}</span>
                        </div>
                    </div>
                    <div class="mb-2">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">Best Trade:</span>
                            <span class="text-success">${formatCurrency(data.best_trade || 0)}</span>
                        </div>
                    </div>
                    <div class="mb-2">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">Worst Trade:</span>
                            <span class="text-danger">${formatCurrency(data.worst_trade || 0)}</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        container.innerHTML = summaryHTML;
    }

    // Load risk metrics
    function loadRiskMetrics() {
        fetch(`/api/analytics/risk-metrics?period=${currentPeriod}`)
            .then(response => response.json())
            .then(data => {
                displayRiskMetrics(data);
            })
            .catch(error => {
                document.getElementById('riskMetrics').innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                        <p>Erro ao carregar dados</p>
                    </div>
                `;
                console.error('Erro ao carregar métricas de risco:', error);
            });
    }

    // Display risk metrics
    function displayRiskMetrics(data) {
        const container = document.getElementById('riskMetrics');
        
        const metricsHTML = `
            <div class="mb-2">
                <div class="d-flex justify-content-between">
                    <span class="text-muted">VaR (95%):</span>
                    <span class="text-danger">${formatCurrency(data.var_95 || 0)}</span>
                </div>
            </div>
            <div class="mb-2">
                <div class="d-flex justify-content-between">
                    <span class="text-muted">Sortino Ratio:</span>
                    <span>${(data.sortino_ratio || 0).toFixed(2)}</span>
                </div>
            </div>
            <div class="mb-2">
                <div class="d-flex justify-content-between">
                    <span class="text-muted">Calmar Ratio:</span>
                    <span>${(data.calmar_ratio || 0).toFixed(2)}</span>
                </div>
            </div>
            <div class="mb-2">
                <div class="d-flex justify-content-between">
                    <span class="text-muted">Beta:</span>
                    <span>${(data.beta || 0).toFixed(2)}</span>
                </div>
            </div>
            <div class="mb-2">
                <div class="d-flex justify-content-between">
                    <span class="text-muted">Alpha:</span>
                    <span class="${data.alpha >= 0 ? 'text-success' : 'text-danger'}">${formatPercentage(data.alpha || 0)}</span>
                </div>
            </div>
            <div class="mb-2">
                <div class="d-flex justify-content-between">
                    <span class="text-muted">Downside Deviation:</span>
                    <span class="text-warning">${formatPercentage(data.downside_deviation || 0)}</span>
                </div>
            </div>
        `;
        
        container.innerHTML = metricsHTML;
    }

    // Load top assets performance
    function loadTopAssetsPerformance() {
        fetch(`/api/analytics/top-assets?period=${currentPeriod}&limit=10`)
            .then(response => response.json())
            .then(data => {
                displayTopAssetsPerformance(data);
            })
            .catch(error => {
                document.getElementById('topAssetsPerformance').innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                        <p>Erro ao carregar dados</p>
                    </div>
                `;
                console.error('Erro ao carregar performance dos ativos:', error);
            });
    }

    // Display top assets performance
    function displayTopAssetsPerformance(data) {
        const container = document.getElementById('topAssetsPerformance');
        const assets = data.assets || [];
        
        if (assets.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-coins fa-2x mb-3"></i>
                    <p>Nenhum dado disponível</p>
                </div>
            `;
            return;
        }
        
        const assetsHTML = assets.map((asset, index) => `
            <div class="d-flex justify-content-between align-items-center py-2 ${index < assets.length - 1 ? 'border-bottom border-secondary' : ''}">
                <div>
                    <strong>${asset.symbol}</strong>
                    <div class="small text-muted">${asset.trades} trades</div>
                </div>
                <div class="text-end">
                    <div class="fw-bold ${asset.pnl >= 0 ? 'text-success' : 'text-danger'}">
                        ${formatCurrency(asset.pnl)}
                    </div>
                    <div class="small text-muted">${formatPercentage(asset.win_rate)}%</div>
                </div>
            </div>
        `).join('');
        
        container.innerHTML = assetsHTML;
    }

    // Load trading hours data
    function loadTradingHoursData() {
        fetch(`/api/analytics/trading-hours?period=${currentPeriod}`)
            .then(response => response.json())
            .then(data => {
                updateTradingHours(data);
            })
            .catch(error => {
                console.error('Erro ao carregar dados de horários:', error);
            });
    }

    // Update trading hours chart
    function updateTradingHours(data) {
        const chart = charts.tradingHours;
        const hourlyData = data.hourly_pnl || [];
        
        // Create array for 24 hours with default 0 values
        const hourlyPnl = new Array(24).fill(0);
        
        // Fill with actual data
        hourlyData.forEach(point => {
            if (point.hour >= 0 && point.hour < 24) {
                hourlyPnl[point.hour] = point.avg_pnl;
            }
        });
        
        chart.data.datasets[0].data = hourlyPnl;
        chart.update();
    }

    // Refresh equity curve
    function refreshEquityCurve() {
        loadEquityCurveData();
        showAlert('info', 'Curva de capital atualizada');
    }

    // Real-time updates
    function updateTradingData(data) {
        if (data.type === 'new_trade' || data.type === 'position_closed') {
            // Refresh analytics data when new trades occur
            setTimeout(() => {
                loadAnalyticsData();
            }, 2000); // Small delay to ensure data is processed
        }
    }

    // Refresh page data
    function refreshPageData() {
        loadAnalyticsData();
    }

    // Socket events specific to analytics page
    socket.on('analytics_update', function(data) {
        loadAnalyticsData();
    });
</script>
{% endblock %}
